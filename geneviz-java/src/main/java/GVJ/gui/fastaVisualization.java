/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package GVJ.gui;

import java.awt.Color;
import java.util.List;
import java.util.Map;

import javax.swing.JOptionPane;
import javax.swing.text.DefaultHighlighter;
import javax.swing.text.Highlighter;

import org.biojava.nbio.core.sequence.DNASequence;
import org.biojava.nbio.genome.parsers.gff.FeatureList;

import static GVJ.utils.GffUtils.getAllGeneIds;
import static GVJ.utils.GffUtils.getCoordsForGene;
import static GVJ.utils.GffUtils.getSequenceIdentifierfromGene;
import static GVJ.utils.GffUtils.getSelectedFeatureLocations;

import GVJ.models.DataManager;
import javax.swing.text.BadLocationException;
import org.biojava.nbio.genome.parsers.gff.Location;

/**
 *
 * @author mspriggs
 */
public class fastaVisualization extends javax.swing.JPanel {

        private DataManager dataManager;

        /**
         * Creates new form fastaVisualization
         */
        public fastaVisualization() {
                initComponents();

                // send geneVisPanel data
                geneVisPanel1.setDataManager(dataManager);

        }

        // Set DataManager

        public void setDataManager(DataManager dataManager) {
                this.dataManager = dataManager;
        }

        // refreshComboBoxes method - #TODO split into smaller methods.
        public void refreshComboBoxes() {

                /*
                 * Update FASTA Sequence Names
                 */
                // Clear existing items
                // #TODO dont refresh if already loaded
                jComboBoxSelectGene.removeAllItems();
                jComboBoxSelectFeature.removeAllItems();

                /*
                 * Update Gene Names from GFF Data
                 */
                // Refresh Gene Selector ComboBox

                // Get all gene IDs from GFF data
                FeatureList gff = dataManager.getGffData();
                List<String> geneIds = getAllGeneIds(gff);

                for (String geneId : geneIds) {
                        jComboBoxSelectGene.addItem(geneId);
                }

                /*
                 * Update Feature Types from hardcoded list #TODO dynamic from GFF
                 */
                List<String> featureTypes = List.of("mRNA", "intron", "exon", "CDS");
                for (String featureType : featureTypes) {
                        jComboBoxSelectFeature.addItem(featureType);
                }

        }

        /**
         * This method is called from within the constructor to initialize the form.
         * WARNING: Do NOT modify this code. The content of this method is always
         * regenerated by the Form Editor.
         */
        @SuppressWarnings("unchecked")
        // <editor-fold defaultstate="collapsed" desc="Generated
        // <editor-fold defaultstate="collapsed" desc="Generated
        // <editor-fold defaultstate="collapsed" desc="Generated
        // <editor-fold defaultstate="collapsed" desc="Generated
        // <editor-fold defaultstate="collapsed" desc="Generated
        // <editor-fold defaultstate="collapsed" desc="Generated
        // <editor-fold defaultstate="collapsed" desc="Generated
        // <editor-fold defaultstate="collapsed" desc="Generated
        // Code">//GEN-BEGIN:initComponents
        private void initComponents() {

                jPanel1 = new javax.swing.JPanel();
                jScrollPane1 = new javax.swing.JScrollPane();
                jTextAreaFastaDisplay = new javax.swing.JTextArea();
                jLabelSelectGene = new javax.swing.JLabel();
                jComboBoxSelectGene = new javax.swing.JComboBox<>();
                jLabelSelectFeature = new javax.swing.JLabel();
                jComboBoxSelectFeature = new javax.swing.JComboBox<>();
                jButtonUpdate = new javax.swing.JButton();
                geneVisPanel1 = new GVJ.gui.geneVisPanel();

                jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder(null, "FASTA Visualization",
                                javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION,
                                javax.swing.border.TitledBorder.TOP));

                jTextAreaFastaDisplay.setColumns(20);
                jTextAreaFastaDisplay.setLineWrap(true);
                jTextAreaFastaDisplay.setRows(5);
                jTextAreaFastaDisplay.setToolTipText("");
                jTextAreaFastaDisplay.setMinimumSize(new java.awt.Dimension(200, 50));
                jScrollPane1.setViewportView(jTextAreaFastaDisplay);

                jLabelSelectGene.setText("Select Gene:");

                jComboBoxSelectGene.setEditable(true);
                jComboBoxSelectGene.setModel(new javax.swing.DefaultComboBoxModel<>(
                                new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));

                jLabelSelectFeature.setText("Select Feature:");

                jComboBoxSelectFeature.setModel(new javax.swing.DefaultComboBoxModel<>(
                                new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));

                jButtonUpdate.setText("Update");
                jButtonUpdate.addActionListener(new java.awt.event.ActionListener() {
                        public void actionPerformed(java.awt.event.ActionEvent evt) {
                                jButtonUpdateActionPerformed(evt);
                        }
                });

                javax.swing.GroupLayout geneVisPanel1Layout = new javax.swing.GroupLayout(geneVisPanel1);
                geneVisPanel1.setLayout(geneVisPanel1Layout);
                geneVisPanel1Layout.setHorizontalGroup(
                                geneVisPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                .addGap(0, 0, Short.MAX_VALUE));
                geneVisPanel1Layout.setVerticalGroup(
                                geneVisPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                .addGap(0, 98, Short.MAX_VALUE));

                javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
                jPanel1.setLayout(jPanel1Layout);
                jPanel1Layout.setHorizontalGroup(
                                jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                .addGroup(jPanel1Layout.createSequentialGroup()
                                                                .addGap(37, 37, 37)
                                                                .addGroup(jPanel1Layout.createParallelGroup(
                                                                                javax.swing.GroupLayout.Alignment.LEADING)
                                                                                .addComponent(jLabelSelectGene,
                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                                126,
                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                                .addComponent(jComboBoxSelectGene,
                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                                187,
                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE))
                                                                .addGap(18, 18, 18)
                                                                .addGroup(jPanel1Layout.createParallelGroup(
                                                                                javax.swing.GroupLayout.Alignment.LEADING)
                                                                                .addComponent(jLabelSelectFeature,
                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                                115,
                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                                .addGroup(jPanel1Layout
                                                                                                .createSequentialGroup()
                                                                                                .addComponent(jComboBoxSelectFeature,
                                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                                                187,
                                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                                                .addGap(58, 58, 58)
                                                                                                .addComponent(jButtonUpdate,
                                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                                                87,
                                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE)))
                                                                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE,
                                                                                Short.MAX_VALUE))
                                                .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout
                                                                .createSequentialGroup()
                                                                .addContainerGap(28, Short.MAX_VALUE)
                                                                .addGroup(jPanel1Layout.createParallelGroup(
                                                                                javax.swing.GroupLayout.Alignment.LEADING,
                                                                                false)
                                                                                .addComponent(jScrollPane1,
                                                                                                javax.swing.GroupLayout.DEFAULT_SIZE,
                                                                                                750, Short.MAX_VALUE)
                                                                                .addComponent(geneVisPanel1,
                                                                                                javax.swing.GroupLayout.DEFAULT_SIZE,
                                                                                                javax.swing.GroupLayout.DEFAULT_SIZE,
                                                                                                Short.MAX_VALUE))
                                                                .addGap(26, 26, 26)));
                jPanel1Layout.setVerticalGroup(
                                jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                .addGroup(jPanel1Layout.createSequentialGroup()
                                                                .addContainerGap(21, Short.MAX_VALUE)
                                                                .addComponent(jScrollPane1,
                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                234,
                                                                                javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                .addGap(18, 18, 18)
                                                                .addComponent(geneVisPanel1,
                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                javax.swing.GroupLayout.DEFAULT_SIZE,
                                                                                javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                .addGap(18, 18, 18)
                                                                .addGroup(jPanel1Layout.createParallelGroup(
                                                                                javax.swing.GroupLayout.Alignment.LEADING)
                                                                                .addGroup(jPanel1Layout
                                                                                                .createSequentialGroup()
                                                                                                .addComponent(jLabelSelectFeature)
                                                                                                .addGap(5, 5, 5)
                                                                                                .addGroup(jPanel1Layout
                                                                                                                .createParallelGroup(
                                                                                                                                javax.swing.GroupLayout.Alignment.BASELINE)
                                                                                                                .addComponent(jComboBoxSelectFeature,
                                                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                                                                javax.swing.GroupLayout.DEFAULT_SIZE,
                                                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                                                                .addComponent(jButtonUpdate)))
                                                                                .addGroup(jPanel1Layout
                                                                                                .createSequentialGroup()
                                                                                                .addComponent(jLabelSelectGene)
                                                                                                .addGap(5, 5, 5)
                                                                                                .addComponent(jComboBoxSelectGene,
                                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                                                javax.swing.GroupLayout.DEFAULT_SIZE,
                                                                                                                javax.swing.GroupLayout.PREFERRED_SIZE)))
                                                                .addGap(45, 45, 45)));

                javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
                this.setLayout(layout);
                layout.setHorizontalGroup(
                                layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                .addGroup(layout.createSequentialGroup()
                                                                .addGap(27, 27, 27)
                                                                .addComponent(jPanel1,
                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                javax.swing.GroupLayout.DEFAULT_SIZE,
                                                                                javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                .addContainerGap(31, Short.MAX_VALUE)));
                layout.setVerticalGroup(
                                layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                                .addGroup(layout.createSequentialGroup()
                                                                .addGap(22, 22, 22)
                                                                .addComponent(jPanel1,
                                                                                javax.swing.GroupLayout.PREFERRED_SIZE,
                                                                                javax.swing.GroupLayout.DEFAULT_SIZE,
                                                                                javax.swing.GroupLayout.PREFERRED_SIZE)
                                                                .addContainerGap(60, Short.MAX_VALUE)));
        }// </editor-fold>//GEN-END:initComponents

        private void jButtonUpdateActionPerformed(java.awt.event.ActionEvent evt) {

                // Update FASTA DisplayBox
                updateFastaDisplay();

                // Highlight selected feature in display
                try {
                        highlightFeatures();
                } catch (BadLocationException e) {
                        // TODO Auto-generated catch block
                        e.printStackTrace();
                }

                // Update geneVisPanel
                String selectedFeature = (String) jComboBoxSelectFeature.getSelectedItem();
                String selectedGene = (String) jComboBoxSelectGene.getSelectedItem();

                geneVisPanel1.setSelectedFeature(selectedFeature);
                geneVisPanel1.setSelectedGene(selectedGene);

        }

        // Variables declaration - do not modify//GEN-BEGIN:variables
        private GVJ.gui.geneVisPanel geneVisPanel1;
        private javax.swing.JButton jButtonUpdate;
        private javax.swing.JComboBox<String> jComboBoxSelectFeature;
        private javax.swing.JComboBox<String> jComboBoxSelectGene;
        private javax.swing.JLabel jLabelSelectFeature;
        private javax.swing.JLabel jLabelSelectGene;
        private javax.swing.JPanel jPanel1;
        private javax.swing.JScrollPane jScrollPane1;
        private javax.swing.JTextArea jTextAreaFastaDisplay;
        // End of variables declaration//GEN-END:variables

        private void updateFastaDisplay() {
                // get selected gene and feature
                String selectedGene = (String) jComboBoxSelectGene.getSelectedItem();

                // verify selectedGene
                // Get all gene IDs from GFF data
                FeatureList gff = dataManager.getGffData();

                List<String> geneIds = getAllGeneIds(gff);

                if (!selectedGene.equals("Select All") && !geneIds.contains(selectedGene)) {
                        JOptionPane.showMessageDialog(this,
                                        "Selected gene '" + selectedGene + "' not found in GFF data.",
                                        "Error",
                                        JOptionPane.ERROR_MESSAGE);
                        return;
                }

                // get coordinates from GFF for selected gene
                Location coords = getCoordsForGene(gff, selectedGene);
                int start = coords.bioStart() - 1; // adjust for 0-based index
                int end = coords.bioEnd();

                // get sequence inferred from selected feature
                String seqKey = getSequenceIdentifierfromGene(gff, selectedGene);

                // Upudate display area
                Map<String, DNASequence> fastaMap = dataManager.getFastaData();
                DNASequence dnaSequence = fastaMap.get(seqKey);
                String fullSequence = dnaSequence.getSequenceAsString();
                String substring = fullSequence.substring(start - 1, end); // Adjust for 0-based index

                jTextAreaFastaDisplay.setText(substring);
        }

        private void highlightFeatures() throws BadLocationException {

                // Get features list
                FeatureList gff = dataManager.getGffData();

                // Get data from jComboBoxSelectGene
                String selectedGene = (String) jComboBoxSelectGene.getSelectedItem();
                System.out.println("Selected Gene: " + selectedGene);

                // get coordinates from GFF for selected gene
                Location coords = getCoordsForGene(gff, selectedGene);
                int geneStart = coords.bioStart(); // relative to full sequence
                int geneEnd = coords.bioEnd(); // relative to full sequence
                int geneLength = coords.length(); // length of gene

                System.out.println("Gene Start: " + geneStart + ", Gene End: " + geneEnd);

                // Get data from jComboBoxSelectFeature
                String selectedFeature = (String) jComboBoxSelectFeature.getSelectedItem();
                System.out.println("Selected Feature: " + selectedFeature);

                // set highlight color
                Color highlightCol = setColor(selectedFeature);

                // Extract a list of Locations for each feature in gene
                List<Location> featureLocations = getSelectedFeatureLocations(gff, selectedGene, selectedFeature);
                System.out.println("Feature Locations: " + featureLocations);

                // feature locations are relative to full sequence, need to adjust to relative
                // to
                // displayed sequence

                for (Location featureLocation : featureLocations) {
                        int featureStart = featureLocation.bioStart() - geneStart; // relative to displayed sequence
                        int featureEnd = featureStart + featureLocation.length() + 1; // relative to displayed sequence
                        System.out.println("Feature Start: " + featureStart + ", Feature End: " + featureEnd);

                        Highlighter highlighter = jTextAreaFastaDisplay.getHighlighter();
                        highlighter.addHighlight(featureStart, featureEnd,
                                        new DefaultHighlighter.DefaultHighlightPainter(highlightCol));

                }

        }

        private Color setColor(String featureType) {
                return switch (featureType) {
                        case "mRNA" -> new Color(135, 206, 250, 150); // Light Blue
                        case "intron" -> new Color(144, 238, 144, 150); // Light Green
                        case "exon" -> new Color(255, 182, 193, 150); // Light Pink
                        case "CDS" -> new Color(255, 255, 0, 150); // Yellow
                        default -> new Color(211, 211, 211, 150); // Light Gray for unknown types
                };
        }

        public void sendDataManagerToGeneVisPanel() {
                geneVisPanel1.setDataManager(dataManager);
        }

}
